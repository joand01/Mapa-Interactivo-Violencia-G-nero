const violencia_gen_mex_2016 = {
    "Aguascalientes": {
        "Total": 53.6,
        "Pareja": 33.0,
        "Familiar": 12.5,
        "Escolar": 20.0,
        "Trabajo": 28.1,
        "Comunitario": 28.7
    },
    "Baja California": {
        "Total": 40.7,
        "Pareja": 19.6,
        "Familiar": 7.8,
        "Escolar": 13.3,
        "Trabajo": 21.5,
        "Comunitario": 21.0
    },
    "Baja California Sur": {
        "Total": 34.2,
        "Pareja": 19.4,
        "Familiar": 6.8,
        "Escolar": 14.0,
        "Trabajo": 16.7,
        "Comunitario": 13.9
    },
    "Campeche": {
        "Total": 35.7,
        "Pareja": 19.5,
        "Familiar": 8.9,
        "Escolar": 14.9,
        "Trabajo": 15.7,
        "Comunitario": 17.1
    },
    "Coahuila": {
        "Total": 46.5,
        "Pareja": 27.1,
        "Familiar": 11.6,
        "Escolar": 18.9,
        "Trabajo": 30.0,
        "Comunitario": 21.8
    },
    "Colima": {
        "Total": 41.2,
        "Pareja": 24.8,
        "Familiar": 9.7,
        "Escolar": 10.4,
        "Trabajo": 18.4,
        "Comunitario": 19.3
    },
    "Chiapas": {
        "Total": 32.4,
        "Pareja": 17.6,
        "Familiar": 7.6,
        "Escolar": 13.6,
        "Trabajo": 18.4,
        "Comunitario": 14.8
    },
    "Chihuahua": {
        "Total": 46.8,
        "Pareja": 27.3,
        "Familiar": 9.8,
        "Escolar": 16.6,
        "Trabajo": 28.4,
        "Comunitario": 23.0
    },
    "Ciudad de México": {
        "Total": 55.1,
        "Pareja": 28.0,
        "Familiar": 9.7,
        "Escolar": 19.7,
        "Trabajo": 22.8,
        "Comunitario": 37.0
    },
    "Durango": {
        "Total": 47.0,
        "Pareja": 27.9,
        "Familiar": 12.4,
        "Escolar": 17.1,
        "Trabajo": 27.6,
        "Comunitario": 22.5
    },
    "Guanajuato": {
        "Total": 42.6,
        "Pareja": 23.7,
        "Familiar": 8.8,
        "Escolar": 18.0,
        "Trabajo": 22.3,
        "Comunitario": 22.2
    },
    "Guerrero": {
        "Total": 36.4,
        "Pareja": 22.6,
        "Familiar": 9.2,
        "Escolar": 14.9,
        "Trabajo": 18.5,
        "Comunitario": 14.4
    },
    "Hidalgo": {
        "Total": 43.2,
        "Pareja": 25.3,
        "Familiar": 10.8,
        "Escolar": 16.3,
        "Trabajo": 21.8,
        "Comunitario": 19.3
    },
    "Jalisco": {
        "Total": 52.0,
        "Pareja": 30.0,
        "Familiar": 12.8,
        "Escolar": 20.5,
        "Trabajo": 25.5,
        "Comunitario": 28.3
    },
    "México": {
        "Total": 53.3,
        "Pareja": 31.0,
        "Familiar": 12.3,
        "Escolar": 17.4,
        "Trabajo": 23.6,
        "Comunitario": 30.8
    },
    "Michoacán": {
        "Total": 44.0,
        "Pareja": 26.9,
        "Familiar": 12.3,
        "Escolar": 20.5,
        "Trabajo": 22.6,
        "Comunitario": 18.5
    },
    "Morelos": {
        "Total": 44.5,
        "Pareja": 25.2,
        "Familiar": 9.9,
        "Escolar": 18.4,
        "Trabajo": 22.3,
        "Comunitario": 21.7
    },
    "Nayarit": {
        "Total": 38.9,
        "Pareja": 24.0,
        "Familiar": 9.5,
        "Escolar": 14.1,
        "Trabajo": 16.3,
        "Comunitario": 15.5
    },
    "Nuevo León": {
        "Total": 38.9,
        "Pareja": 19.0,
        "Familiar": 6.9,
        "Escolar": 17.3,
        "Trabajo": 20.2,
        "Comunitario": 22.6
    },
    "Oaxaca": {
        "Total": 39.7,
        "Pareja": 24.7,
        "Familiar": 11.3,
        "Escolar": 17.8,
        "Trabajo": 18.6,
        "Comunitario": 14.8
    },
    "Puebla": {
        "Total": 44.0,
        "Pareja": 25.3,
        "Familiar": 11.1,
        "Escolar": 17.5,
        "Trabajo": 22.0,
        "Comunitario": 21.6
    },
    "Querétaro": {
        "Total": 49.9,
        "Pareja": 26.4,
        "Familiar": 11.5,
        "Escolar": 18.8,
        "Trabajo": 28.9,
        "Comunitario": 28.5
    },
    "Quintana Roo": {
        "Total": 46.1,
        "Pareja": 25.2,
        "Familiar": 10.0,
        "Escolar": 18.2,
        "Trabajo": 24.7,
        "Comunitario": 24.8
    },
    "San Luis Potosí": {
        "Total": 38.1,
        "Pareja": 23.4,
        "Familiar": 9.0,
        "Escolar": 13.0,
        "Trabajo": 18.3,
        "Comunitario": 18.8
    },
    "Sinaloa": {
        "Total": 38.5,
        "Pareja": 23.0,
        "Familiar": 9.8,
        "Escolar": 16.3,
        "Trabajo": 21.1,
        "Comunitario": 16.1
    },
    "Sonora": {
        "Total": 39.7,
        "Pareja": 23.3,
        "Familiar": 8.7,
        "Escolar": 14.3,
        "Trabajo": 20.2,
        "Comunitario": 18.6
    },
    "Tabasco": {
        "Total": 35.6,
        "Pareja": 21.5,
        "Familiar": 8.1,
        "Escolar": 13.8,
        "Trabajo": 16.5,
        "Comunitario": 16.7
    },
    "Tamaulipas": {
        "Total": 37.3,
        "Pareja": 19.5,
        "Familiar": 8.1,
        "Escolar": 17.1,
        "Trabajo": 20.6,
        "Comunitario": 19.9
    },
    "Tlaxcala": {
        "Total": 41.7,
        "Pareja": 24.7,
        "Familiar": 10.0,
        "Escolar": 15.9,
        "Trabajo": 21.2,
        "Comunitario": 18.7
    },
    "Veracruz": {
        "Total": 41.3,
        "Pareja": 24.3,
        "Familiar": 11.1,
        "Escolar": 18.5,
        "Trabajo": 20.9,
        "Comunitario": 19.6
    },
    "Yucatán": {
        "Total": 45.8,
        "Pareja": 27.7,
        "Familiar": 9.1,
        "Escolar": 17.1,
        "Trabajo": 19.3,
        "Comunitario": 22.6
    },
    "Zacatecas": {
        "Total": 39.8,
        "Pareja": 26.3,
        "Familiar": 9.5,
        "Escolar": 20.2,
        "Trabajo": 22.9,
        "Comunitario": 16.4
    }
};

const violencia_gen_mex_2021 = { "Aguascalientes": { "Total": 48.0, "Pareja": 24.8, "Familiar": 12.9, "Escolar": 21.1, "Trabajo": 26.1, "Comunitario": 25.9 }, "Baja California": { "Total": 37.2, "Pareja": 13.3, "Familiar": 8.6, "Escolar": 13.0, "Trabajo": 21.6, "Comunitario": 18.6 }, "Baja California Sur": { "Total": 38.4, "Pareja": 17.9, "Familiar": 8.4, "Escolar": 17.5, "Trabajo": 18.9, "Comunitario": 20.2 }, "Campeche": { "Total": 39.7, "Pareja": 20.0, "Familiar": 10.7, "Escolar": 17.3, "Trabajo": 16.9, "Comunitario": 19.8 }, "Coahuila": { "Total": 45.9, "Pareja": 22.3, "Familiar": 11.6, "Escolar": 23.4, "Trabajo": 22.1, "Comunitario": 25.3 }, "Colima": { "Total": 48.2, "Pareja": 23.0, "Familiar": 11.6, "Escolar": 20.7, "Trabajo": 21.0, "Comunitario": 26.5 }, "Chiapas": { "Total": 26.9, "Pareja": 12.6, "Familiar": 6.5, "Escolar": 21.8, "Trabajo": 12.6, "Comunitario": 13.6 }, "Chihuahua": { "Total": 43.9, "Pareja": 19.1, "Familiar": 11.6, "Escolar": 21.1, "Trabajo": 27.5, "Comunitario": 21.2 }, "Ciudad de México": { "Total": 46.1, "Pareja": 18.9, "Familiar": 15.0, "Escolar": 25.4, "Trabajo": 24.4, "Comunitario": 27.6 }, "Durango": { "Total": 43.1, "Pareja": 22.4, "Familiar": 10.7, "Escolar": 23.6, "Trabajo": 22.7, "Comunitario": 22.2 }, "Guanajuato": { "Total": 44.4, "Pareja": 22.3, "Familiar": 10.9, "Escolar": 19.7, "Trabajo": 22.5, "Comunitario": 22.8 }, "Guerrero": { "Total": 44.1, "Pareja": 25.9, "Familiar": 15.0, "Escolar": 20.0, "Trabajo": 14.8, "Comunitario": 19.0 }, "Hidalgo": { "Total": 43.0, "Pareja": 23.9, "Familiar": 11.7, "Escolar": 19.3, "Trabajo": 19.3, "Comunitario": 19.9 }, "Jalisco": { "Total": 45.8, "Pareja": 22.0, "Familiar": 11.6, "Escolar": 21.2, "Trabajo": 23.0, "Comunitario": 25.9 }, "México": { "Total": 47.6, "Pareja": 21.7, "Familiar": 10.9, "Escolar": 18.4, "Trabajo": 22.4, "Comunitario": 27.1 }, "Michoacán": { "Total": 42.7, "Pareja": 24.3, "Familiar": 12.2, "Escolar": 23.9, "Trabajo": 18.8, "Comunitario": 19.6 }, "Morelos": { "Total": 42.6, "Pareja": 19.4, "Familiar": 11.5, "Escolar": 19.3, "Trabajo": 18.0, "Comunitario": 23.3 }, "Nayarit": { "Total": 41.3, "Pareja": 23.3, "Familiar": 10.9, "Escolar": 20.7, "Trabajo": 16.0, "Comunitario": 19.4 }, "Nuevo León": { "Total": 42.3, "Pareja": 17.7, "Familiar": 9.6, "Escolar": 19.1, "Trabajo": 22.1, "Comunitario": 24.1 }, "Oaxaca": { "Total": 39.1, "Pareja": 21.2, "Familiar": 12.0, "Escolar": 15.5, "Trabajo": 16.1, "Comunitario": 16.6 }, "Puebla": { "Total": 41.0, "Pareja": 21.4, "Familiar": 10.6, "Escolar": 15.8, "Trabajo": 20.4, "Comunitario": 19.9 }, "Querétaro": { "Total": 49.8, "Pareja": 25.1, "Familiar": 14.6, "Escolar": 29.4, "Trabajo": 24.6, "Comunitario": 27.9 }, "Quintana Roo": { "Total": 44.2, "Pareja": 18.8, "Familiar": 9.9, "Escolar": 20.5, "Trabajo": 22.9, "Comunitario": 25.4 }, "San Luis Potosí": { "Total": 41.7, "Pareja": 21.6, "Familiar": 9.5, "Escolar": 13.2, "Trabajo": 20.8, "Comunitario": 20.6 }, "Sinaloa": { "Total": 38.9, "Pareja": 19.0, "Familiar": 10.9, "Escolar": 14.4, "Trabajo": 18.8, "Comunitario": 16.8 }, "Sonora": { "Total": 44.5, "Pareja": 22.3, "Familiar": 12.3, "Escolar": 18.1, "Trabajo": 23.0, "Comunitario": 20.8 }, "Tabasco": { "Total": 39.6, "Pareja": 21.0, "Familiar": 11.3, "Escolar": 21.1, "Trabajo": 17.4, "Comunitario": 20.2 }, "Tamaulipas": { "Total": 34.2, "Pareja": 16.7, "Familiar": 7.9, "Escolar": 18.6, "Trabajo": 14.6, "Comunitario": 17.8 }, "Tlaxcala": { "Total": 42.7, "Pareja": 20.7, "Familiar": 11.9, "Escolar": 23.0, "Trabajo": 22.5, "Comunitario": 21.6 }, "Veracruz": { "Total": 41.6, "Pareja": 21.4, "Familiar": 13.8, "Escolar": 24.1, "Trabajo": 18.1, "Comunitario": 20.4 }, "Yucatán": { "Total": 44.9, "Pareja": 23.1, "Familiar": 11.4, "Escolar": 24.8, "Trabajo": 18.9, "Comunitario": 24.2 }, "Zacatecas": { "Total": 37.9, "Pareja": 20.6, "Familiar": 8.8, "Escolar": 24.0, "Trabajo": 19.4, "Comunitario": 18.2 } };

function lerp(a, b, t) {
    return a - (a - b) * t;
}

function mixHexColors(c1, c2, t) {
    let str = '#'
    for (let i = 0; i < 3; i++) {
        let idx = i * 2 + 1;
        let a = parseInt(c1.slice(idx, idx + 2), 16);
        let b = parseInt(c2.slice(idx, idx + 2), 16);
        let c = Math.round(lerp(a, b, t));
        if (c < 16) str += '0';
        str += c.toString(16);
    }

    return str;
}

function getSVGCenter(path) {
    const box = path.getBBox();
    const cx = Math.round(box.x + box.width / 2);
    const cy = Math.round(box.y + box.height / 2);
    return [cx, cy];
}

window.onload = function () {

    const map = document.getElementById("mexico-map");
    const states = map.querySelectorAll('path');
    const features = document.getElementById('features');
    const dataSelector = document.getElementById('data-sel');
    const description = document.getElementsByClassName("description")[0];
    const pieTitle = document.getElementById("pie-title");

    const coldColor = '#2c242d';
    const hotColor = '#d190f1';

    let selected = null;
    let dataset = violencia_gen_mex_2016;

    function setHeatmapNumberData(data, coldColor, hotColor) {
        let indices = [];

        states.forEach(state => {
            const name = state.getAttribute("name");
            indices.push(data[name]["Total"]);
        });

        let A = Math.min.apply(Math, indices);
        let B = Math.max.apply(Math, indices);

        states.forEach(state => {
            const name = state.getAttribute("name");
            let index = data[name]["Total"];
            let m = 1 / (B - A)
            let b = -A * m;
            let t = (m * index + b);
            state.style.fill = mixHexColors(hotColor, coldColor, t);
        });
    }

    dataSelector.onchange = () => {
        switch (dataSelector.value) {
            default:
            case "vg-2016": dataset = violencia_gen_mex_2016; break;
            case "vg-2021": dataset = violencia_gen_mex_2021; break;
        }

        setHeatmapNumberData(dataset, coldColor, hotColor);
        if (selected != null) {
            chart.data.datasets[0].data = data.labels.map(param => dataset[selected.getAttribute("name")][param]);
            chart.update();
        }
    }

    const ctx = document.getElementById('pieChart').getContext('2d');
    const colors = Array.from(Array(5).keys().map((x) => mixHexColors(hotColor, coldColor, x * 0.2)));

    const data = {
        labels: ["Pareja", "Familiar", "Escolar", "Trabajo", "Comunitario"],
        datasets: [{
            label: 'Porcentaje',
            backgroundColor: colors,
            borderWidth: 1
        }]
    };

    const options = {
        responsive: true,
        animation: {
            animateScale: true,  // Animate the scale (smooth transition)
            animateRotate: true, // Animate rotation
        },
        hover: {
            mode: 'index',
            intersect: false,
            animationDuration: 200, // Speed of hover animation
        },
        plugins: {
            tooltip: {
                enabled: true, // Enable tooltips
            },
            plugins: {
                datalabels: {
                    formatter: (value, ctx) => {
                        return percentage.toFixed(2) + "%"; 
                    },
                    color: '#ffffff'
                }
            }
        },
        // Customizing hover effect (scaling the slice)
        onHover: (event, chartElement) => {
            const index = chartElement.length > 0 ? chartElement[0].index : -1;
            if (index !== -1) {
                // Apply scaling effect
                chart.data.datasets[0].hoverOffset = 50; // Adjust this value to scale the slices
                chart.update();
            }
        },
        onHoverOut: () => {
            chart.data.datasets[0].hoverOffset = 0; // Reset scaling on hover out
            chart.update();
        }
    };

    const config = {
        type: 'pie',
        data: data,
        options: options
    };

    const chart = new Chart(ctx, config);

    setHeatmapNumberData(violencia_gen_mex_2016, coldColor, hotColor);

    states.forEach(state => {
        state.style.transition = "scale .5s, fill 1s linear, stroke 1s";
        const name = state.getAttribute("name");
        const [cx, cy] = getSVGCenter(state);

        state.style.transformOrigin = ` ${cx}px ${cy}px `;

        state.addEventListener('mouseenter', () => {
            features.removeChild(state); features.appendChild(state);
            if (selected != null) {
                features.removeChild(selected); features.appendChild(selected);
            }

            state.style.scale = "1.2";
            state.style.strokeWidth = "2px";
            description.classList.add("active");
            description.innerHTML = `<div>${name}</div> <small>${dataset[name]["Total"]} %</small>`;
        });

        state.addEventListener('mouseleave', () => {
            state.style.scale = "1.0";
            if (selected == state) {
                state.style.strokeWidth = "3px";
            } else {
                state.style.strokeWidth = "1px";
            }
            
            description.classList.remove("active");
        });

        state.addEventListener('click', () => {
            features.removeChild(state); features.appendChild(state);

            if (selected != null) {
                selected.classList.remove("selected");
                selected.style.strokeWidth = "1px";
            }

            state.classList.add("selected");
            pieTitle.innerText = `Subdivisión de las personas afectadas (${state.getAttribute("name")}) según el tipo de violencia`;
            console.log(pieTitle.innerText);

            chart.data.datasets[0].data = data.labels.map(param => dataset[name][param]);
            chart.update();
            selected = state;
        });

        document.onmousemove = (e) => {
            description.style.left = `${e.clientX}px`;
            description.style.top = `${e.clientY - 70}px`;
        };
    });


};
